; ********************************************************************************************************************************************************
;***          Traffic lights (contains all the code for the Traffic lights)                                                                                    ****
;*********************************************************************************************************************************************************



;*********************************************************************************************************************************************************
; LOGBOOK OF UPDATES IN THIS FILE
; --Date--- |-----Description--------------------------------------------------------------------------------|---Person(s)-------------------------------
; 20250423    Initial template of a dummy-breed to be adapted by the project group                               Gion
; 20250426    skapa atemplete                                                                                    Fadi
; 20250426     skapa nya traffic lights (korsningar)                                                             Hamdi
; 20250501    börja med proactiva delen  (beliefs)                                                               Daniel                                                                   
; 20250501    fortsätta med proactiva delen  (deliberation och intention)                                        Hamdi och Daniel
; 20250503    proactiva delen klar                                                                               Daniel och Fadi 
; 20250505    tester med hybrid agent                                                                            Fadi 
; 20250507    sätta ihop denna reactiva och proactiva tsm genom hybrid                                           Daniel och Hamdi
; 20250512    la till fler traffiljust och gjort om koden för skapandet av traffikljus så att det blir enklare   Hamdi 
; 20250512    fixa det ett litet bug med traffiljusen och fixade till positionerna av vissa traffikljus          Hamdi 
; 20250518    tagit brt att reactive del tar hansyn till gruppen som är grön i början                            Hamdi doch daniel
; 20250518    lagt till så att de vertikala trafikljus är gröna i början när det gäller kornsingar               daniel 
; 20250518    Minksat koden i reaktive och kommenterat den                                                       Hamdi 
; 20250518    Lagt till en metod som läser medelanden                                                            fadi och daniel 
; 20250518    Lagt till ny gående traffikljus som ska kommunicera med männikor                                   fadi och hamdi 
; 20250518    Lagt till en metod som håller de trafikljusen utanför korninsgar röda                              fadi 
; 20250518    tester med att ta emot meddelanden mellan human och tarfficlight                                   hamdi fadi och daniel 
; 20240522    ändrat hur tarffikljus utanför korsningar blir röda (snabbare kod)                                 Daniel 


;
;********************end logbook ************************************************************************************************************************
;*********************************************************************************************************************************************************

;Local Varaiables 
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************
traffic-lights-own [
  remaining-ticks
  state          
  group
  crossing
  belief
  desire
  intention
  crossing-timer 
  incoming-queue
  no-crossing-pedestrian-id
]
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************


; SETUP FUNCTIONS
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************
to setup-no-crossing-light-data
  set ped-id [ 
    [ 
      1

      [ [ -77 45] [ -77 39]]  

    ]
    
    [ 
      2

      [ [ -66 77] [ -59.5 77] ]

    ]
    
     [ 
      3

      [ [ -66 35] [ -59.5 35] ]
    ]
     [ 
      4
      [ [ -18 35] [ -24 35 ] ]
    ]
     [ 
      5
      [ [ 24 35  ] [ 18 35 ] ]

    ]
    
    [ 
      6

      [ [ 66 35 ] [ 60 35 ] ]

    ]
    
      [ 
      7

      [ [ 77 45 ] [ 77 39] ]

    ]
    
    [ 
      8

      [ [ -18 77 ] [ -24 77 ] ]

    ]
    
     [ 
      9

      [ [ 24 77 ] [ 18 77  ] ]

    ]
    
    [ 
      10

      [ [ 66 77 ] [ 60 77 ] ]

    ]
    
      [ 
      11

      [ [ 66 -7  ] [ 60 -7 ] ]

    ]
    
    [ 
      12

      [ [ 24 -7  ] [ 18 -7 ] ]

    ]
    
    [ 
      13

      [ [ -18 -7 ] [ -24 -7 ] ]

    ]
    
       [ 
      14

      [ [ -66 -7 ] [ -59.5 -7 ] ]

    ]
    
     [ 
      15 

      [ [ -77 -39 ] [ -77 -45 ]]  

    ]
    
       [ 
      16

      [ [ 77 -39 ] [ 77 -45 ] ]

    ]
    
     
  ]
end

to setup-crossings-data
  set crossings [ 
    [ 
      1  ; Crossing number
      [ [ -87 12 3 ] [ -81 -12 3 ] [ -77 3 2 ] [ -77 -3 2 ] ]  
      [ [ -87 -7 2 ] [ -87 7 2 ] [ -81 -7 2 ] [ -81 7 2 ] [ -72 2 3 ] ] 
    ]
    
    [ 
      2
      [ [ -39 -12 3 ] [ -45 12 3 ] [ -49 3 2 ] [ -49 -3 2 ] [ -35 -3 2 ] [ -35 3 2 ] ]
      [ [ -39 7 2 ] [ -45 7 2 ] [ -45 -7 2 ] [ -39 -7 2 ] [ -30 3 3 ] [ -54 -3 3 ] ]
    ]
   
    [ 
      3
      [ [ -3 12 3 ] [ 3 -12 3 ] [ -7 3 2 ] [ -7 -3 2 ] [ 7 3 2 ] [ 7 -3 2 ] ]
      [ [ 3 7 2 ] [ 3 -7 2 ] [ -3 7 2 ] [ -3 -7 2 ] [ 12 3 3 ] [ -12 -3 3 ] ]
    ]
    
    [ 
      4
      [ [ 39 12 3 ] [ 45 -12 3 ] [ 49 3 2 ] [ 49 -3 2 ] [ 35 3 2 ] [ 35 -3 2 ] ]
      [ [ 45 7 2 ] [ 45 -7 2 ] [ 39 7 2 ] [ 39 -7 2 ] [ 54 3 3 ] [ 30 -3 3 ] ]
    ]
    
    [ 
      5
      [ [ 81 12 3 ] [ 87 -12 3 ] [ 77 3 2 ] [ 77 -3 2 ] ]
      [ [ 87 -7 2 ] [ 87 7 2 ] [ 81 -7 2 ] [ 81 7 2 ] [ 72 -2 3 ] ]
    ] 
    
     [ 
      6
      [ [ -39 30 3 ] [ -45 54 3 ] [ -49 45 2 ] [ -49 39 2 ] [ -35 45 2 ] [ -35 39 2 ] ]
      [ [ -39 49 2 ] [ -45 49 2 ] [ -45 35 2 ] [ -39 35 2 ] [ -30 45 3 ] [ -54 39 3 ] ]
    ]
    
     [ 
      7
      [ [ -3 54 3 ] [ 3 30 3 ] [ -7 45 2 ] [ -7 39 2 ] [ 7 45 2 ] [ 7 39 2 ] ]
      [ [ 4 49 2 ] [ 4 35 2 ] [ -3 49 2 ] [ -3 35 2 ] [ 12 45 3 ] [ -12 39 3 ] ]
    ]
    
        [ 
      8
      [ [ 39 54 3 ] [ 45 30 3 ] [ 49 45 2 ] [ 49 39 2 ] [ 35 45 2 ] [ 35 39 2 ] ]
      [ [ 45 49 2 ] [ 45 35 2 ] [ 39 35 2 ] [ 39 49 2 ] [ 54 45 3 ] [ 30 40 3 ] ]
    ]
    
    
    
      [ 
      9
      [ [ -39 72 3 ]  [ -49 81 2 ] [ -49 87 2 ] [ -35 81 2 ] [ -35 87 2 ] ]
      [ [ -39 77 2 ] [ -45 77 2 ] [ -30 87 3 ] [ -54 81 3 ] ]
    ]
    
      [ 
      10
      [ [ 3 72 3 ] [ -7 81 2 ] [ -7 87 2 ] [ 7 81 2 ] [ 7 87 2 ] ]
      [ [ -3 77 2 ] [ 4 77 2 ] [ 12 87 3 ] [ -12 81 3 ] ]
    ]
    
    [ 
      11
      [[ 45 72 3 ] [ 49 81 2 ] [ 49 87 2 ] [ 35 81 2 ] [ 35 87 2 ] ]
      [ [ 39 77 2 ] [ 46 77 2 ] [ 54 87 3 ] [ 30 81 3 ] ]
    ]
    
    
     [ 
      12
      [ [ -45 -30 3 ]  [ -49 -39 2 ] [ -49 -45 2 ] [ -35 -39 2 ] [ -35 -45 2 ] ]
      [ [ -38 -35 2 ] [ -45.5 -35 2 ] [ -30 -39 3 ] [ -54 -45 3 ] ]
    ]
    
      [ 
      13
      [ [ -3 -30 3 ] [ -7 -39 2 ] [ -7 -45 2 ] [ 7 -39 2 ] [ 7 -45 2 ] ]
      [ [ -4 -35 2 ] [ 4 -35 2 ] [ 12 -39 3 ] [ -12 -45 3 ] ]
    ]
    
     [ 
      14
      [[ 39 -30 3 ] [ 49 -39 2 ] [ 49 -45 2 ] [ 35 -39 2 ] [ 35 -45 2 ] ]
      [ [ 39 -35 2 ] [ 46 -35 2 ] [ 54 -39 3 ] [ 30 -45 3 ] ]
    ] 
  ]
end
to create-lights
 setup-crossings-data  
  foreach crossings [ cr ->
    let cn item 0 cr   
    let vert item 1 cr  
    let horz item 2 cr  

    foreach vert [ v ->
      create-traffic-lights 1 [
        setxy item 0 v item 1 v
        set shape "circle"  
        set color green
        set size item 2 v
        set state "green"
        set group "vertical"
        set crossing cn
        set belief "unknown"
        set desire "none"
        set intention "none"
        set crossing-timer 0
        set incoming-queue[]
      ]
    ]

    foreach horz [ h ->
      create-traffic-lights 1 [
        setxy item 0 h item 1 h
        set shape "circle"
        set color red
        set size item 2 h
        set state "red"
        set group "horizontal"
        set crossing cn
        set belief "unknown"
        set desire "none"
        set intention "none"
        set crossing-timer 0
        set incoming-queue[]
      ]
    ]
  ]
  
  setup-no-crossing-light-data
  foreach ped-id [ 
    ped-group ->
    let number item 0 ped-group
      let positions item 1 ped-group 
      foreach positions [
        pos ->
          create-traffic-lights 1 [
            set xcor item 0 pos  
            set ycor item 1 pos  
            set color red

            set size 2 
            set shape "circle"  

            set incoming-queue[]
           set no-crossing-pedestrian-id number
        
            
          ]
      ]
  ]
  
end

;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************


; UPDATE BELIEFS
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************

to update-beliefs-trafficlights  
  if crossing-timer mod 5000 = 0 [
    set belief "time-to-switch"
  ]
  if crossing-timer mod 5000 != 0 [
    set belief "no-change"
  ]
  ;turn-red
  read-messages

end
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************
;HELPER METHODS 
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************
to read-messages 
  while [not empty? incoming-queue][
    let received-message get-message ;Hämta meddelandet 
    let performative get-performative received-message  ; hämta performative
    let content get-content received-message ; hämta content
    
    if (performative = "request") [  ; om det är en request
      if (no-crossing-pedestrian-id != 0) [ ;kolla bara på traffikljus som är inte i en korsning 
        if (substring content 0 11 = "turn-green_") [ ;dela upp meddelandet efter 11 tecken
          let light-id read-from-string (substring content 11 (length content)) ; efter 11 tecekn är det idet på tarfickljsuet vi ska ändra på 
          if light-id = who [ ; om det mathcar mig 
            set color green ; sätt grön 
            let our-group no-crossing-pedestrian-id ; spara mitt id i varaibeln 
            ask traffic-lights with [   ; för alla tarffik ljus 
              no-crossing-pedestrian-id = our-group and who != self ; alla som har samma id som mig och undvink att kalla på mig för att det skapar ett bugg
            ] [
              set color green ; sät den till grön och på så sätt kommer båda trafikljsen vara gröna 
            ]
          ]
        ]
        
        
      ]
     
    ]
  ]
end  

to turn-red
if (no-crossing-pedestrian-id != 0) [ ; så länge ett tarffikljus har ett gilitid värde på varaibeln 
  if (not any? (humans in-radius 4)) [ ; kolla om har någon nära 
    let our-group no-crossing-pedestrian-id; spara id

    let partners traffic-lights with [ ; spara också de traffikljusen som har samma id som mig 
      no-crossing-pedestrian-id = our-group and who != [who] of myself
    ]
    ; om ingen av oss har någon nära sig 
    if (all? partners [not any? (humans in-radius 4)]) [
       ; sätt röd 
      ask partners [ set color red ]
      set color red  ; jag ska osså vara röd 
    ]
  ]
]
  

end
;END HELPETER METHODS 
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************



; PROACTIVE BEHAVIOR
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************
to deliberate 
  if belief = "time-to-switch" [
    if group = "vertical" [
      if color = green [ set desire "turn-red" ]
      if color = red [ set desire "turn-green" ]
    ]
    if group = "horizontal" [
      if color = red [ set desire "turn-green" ]
      if color = green [ set desire "turn-red" ]
    ]
  ]
  if belief = "no-change" [
    set desire "none"
  ]
end

to formulate-intention  
  if desire = "turn-green" [
    set intention "be-green"
  ]
  if desire = "turn-red" [
    set intention "be-red"
  ]
  if desire = "none" [
    set intention "none"
  ]
end

to execute  
  if intention = "be-green" [
    set color green
    set crossing-timer 0 
  ]
  if intention = "be-red" [
    set color red
    set crossing-timer 0 
  ]
end

to proactive_traffic-light  
  update-beliefs-trafficlights 
  deliberate
  formulate-intention
  execute
  set crossing-timer crossing-timer + 1
  
end

;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************

; REACTIVE SUBSUMPTION HIERARCHY
;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************
;vertical architecture, den reaktiva delen kallar den proaktiva vid vissa situationer, alltså skickar över till nästa lager  
to reactive_traffic_light
   turn-red
  ;FÖR ALLA KORSNINGAR
 foreach remove-duplicates [crossing] of traffic-lights [ cr ->
    let cr-lights traffic-lights with [crossing = cr] ;SAMLA ALLA TRAFFIKLJUS MED SAMMA KORSNING ID
    ask cr-lights [  ;FÖR ALLA TRAFFIKLJUS I DENNA KORSNING 
      if remaining-ticks > 0 [ set remaining-ticks remaining-ticks - 1 ]  ; MINSKA TIMER MED EN TICK 
    ]

    let p-lights cr-lights with [group = "vertical"]   ; SPARA VERTICALA TRAFIKLJUS I DENNA KORSNINGEN I EN VARAIBEL 
    let v-lights cr-lights with [group = "horizontal"] ; SPARA VERTICALA TRAFIKLJUS I DENNA KORSNINGEN I EN VARAIBEL 

      let peds-in-p? any? p-lights with [any? humans in-radius 3] ; KOLLA OM DET FINNS MÄNNIKSOR NÄRA VERTIKALA TRAFFIKLJUS I DENNA KORSNING
      let peds-in-v? any? v-lights with [any? humans in-radius 3]  ; KOLLA OM DET FINNS MÄNNIKSOR NÄRA HORIZONTELL TRAFFIKLJUS I DENNA KORSNING

        if (peds-in-p? or peds-in-v?) [  ; FINNS DET NÅGON SOM VÄNTAR I ANTIGEN VERTIKAL ELLER HORIZONTEL
          let target-group ifelse-value (peds-in-p?) ["vertical"] ["horizontal"] ; VÄLJ DEN RIKTINING DÄR MÄNNISKOR FINNS
          ask cr-lights with [group = target-group] [; FÖR DENNA GRUPPEN, ALLTSÅ DÄR MÄNNISKORNA VÄNTAR 
            set state "green" ; STATE ÄR GRÖN 
            set color green ;  ÄNDRA FÄRG TILL GRÖN 
            set remaining-ticks 5 ;REST TIME
          ]
          ask cr-lights with [group != target-group] [; FÖR ANDRA GRUPPEN DÄR MÄNNISKOR EJ VÄNTAR 
            set state "red" ; STATE ÄR RÖD 
            set color red ; FÄRG ÄR RÖD 
            ;set remaining-ticks 0 ; SÄTT TIMER TILL 0, SÅ ATT DEN INTE FLICKAR 
          ] 
    ]

    

            ask cr-lights [ proactive_traffic-light ] ; FINNS INGEN SOM VÄNTAR DÅ KALLAR VI DEN PROACTIVA 
      
    
  ]
end

;*********************************************************************************************************************************************************
;*********************************************************************************************************************************************************




